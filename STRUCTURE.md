# GitOps Platform - Repository Structure

## Complete File Structure

```
gitops-platform/
│
├── README.md                          # Main documentation
├── ARCHITECTURE.md                    # Detailed architecture guide
├── QUICK-REFERENCE.md                 # Quick command reference
├── TROUBLESHOOTING.md                 # Troubleshooting guide
├── .gitignore                        # Git ignore rules
│
├── argocd/                           # ArgoCD Applications
│   ├── applications/
│   │   ├── app-of-apps.yaml         # ⭐ Main entry point (apply this first)
│   │   ├── operators.yaml           # Operators application
│   │   ├── kafka.yaml               # Kafka application
│   │   ├── rabbitmq.yaml            # RabbitMQ application
│   │   ├── camelk.yaml              # Camel K application
│   │   └── backstage.yaml           # Backstage application
│   └── kustomization.yaml
│
├── base/                             # Base Kubernetes manifests
│   ├── operators/                    # All operators in one namespace
│   │   ├── strimzi-operator.yaml    # Kafka operator (Strimzi v0.43.0)
│   │   ├── rabbitmq-operator.yaml   # RabbitMQ operator (v2.10.0)
│   │   ├── camelk-operator.yaml     # Camel K operator (v2.5.0)
│   │   └── kustomization.yaml
│   │
│   ├── kafka/                        # Kafka cluster configuration
│   │   ├── kafka-cluster.yaml       # 3 brokers + 3 Zookeeper + topics
│   │   └── kustomization.yaml
│   │
│   ├── rabbitmq/                     # RabbitMQ cluster configuration
│   │   ├── rabbitmq-cluster.yaml    # 3 replicas with HA
│   │   └── kustomization.yaml
│   │
│   ├── camelk/                       # Camel K platform configuration
│   │   ├── integration-platform.yaml # IntegrationPlatform + Maven settings
│   │   └── kustomization.yaml
│   │
│   ├── backstage/                    # Backstage developer portal
│   │   ├── backstage.yaml           # Backstage + PostgreSQL
│   │   └── kustomization.yaml
│   │
│   └── user-namespace/               # User namespace template
│       ├── user-template.yaml       # Template with RBAC, quotas, NetworkPolicy
│       └── kustomization.yaml
│
├── overlays/                         # Environment-specific overlays
│   ├── local/                        # Local Kind cluster optimizations (empty - for future)
│   └── users/                        # Per-user namespace customizations
│       ├── user1/                    # Generated by create-user.sh
│       ├── user2/                    # Generated by create-user.sh
│       └── user3/                    # Generated by create-user.sh
│
├── scripts/                          # Automation scripts
│   ├── bootstrap-argocd.sh          # Initial platform setup
│   └── create-user.sh               # Create new user namespace
│
└── examples/                         # Example integrations
    └── camelk-integrations.yaml     # 6 example Camel K integrations
```

## Key Files Description

### Entry Points

1. **argocd/applications/app-of-apps.yaml**
   - Main ArgoCD application that deploys everything
   - Apply this first: `kubectl apply -f argocd/applications/app-of-apps.yaml`

2. **scripts/bootstrap-argocd.sh**
   - Interactive setup script
   - Checks prerequisites and guides through deployment

3. **scripts/create-user.sh**
   - Creates isolated user namespaces
   - Usage: `./scripts/create-user.sh user1`

### Base Configurations

**Operators** (namespace: operators):
- All operators in single namespace for easier management
- Includes full RBAC and CRD definitions
- Watch specific namespaces (kafka, rabbitmq, etc.)

**Kafka** (namespace: kafka):
- 3 Kafka brokers with 10Gi storage each
- 3 Zookeeper nodes with 5Gi storage each
- Pre-configured topics: events, commands, notifications
- JMX metrics enabled

**RabbitMQ** (namespace: rabbitmq):
- 3-node cluster with automatic peer discovery
- Management UI on port 15672
- HA policy for all queues
- Multiple plugins enabled

**Camel K** (namespace: camelk):
- IntegrationPlatform with Maven settings
- Resource limits configured
- JVM and GC traits enabled

**Backstage** (namespace: backstage):
- Developer portal with service catalog
- PostgreSQL database (5Gi)
- Kubernetes plugin enabled
- Read-only cluster access

**User Namespace Template**:
- ResourceQuota: 4 CPU / 8Gi memory (requests)
- NetworkPolicy: Access to Kafka and RabbitMQ only
- RBAC: Limited to namespace resources
- IntegrationPlatform: Per-user Camel K configuration

### Documentation

- **README.md**: Getting started guide
- **ARCHITECTURE.md**: Deep dive into components and design
- **QUICK-REFERENCE.md**: Command cheat sheet
- **TROUBLESHOOTING.md**: Common issues and solutions

### Examples

**examples/camelk-integrations.yaml** includes:
1. Kafka consumer
2. Kafka producer
3. RabbitMQ consumer
4. Kafka-to-RabbitMQ bridge
5. HTTP-to-Kafka webhook
6. Data transformer

## Deployment Flow

```
1. Push to Git repository
   ↓
2. Apply app-of-apps.yaml to ArgoCD
   ↓
3. ArgoCD syncs all applications
   ↓
4. Operators deploy first (wave 0)
   ↓
5. Infrastructure deploys (wave 1)
   - Kafka cluster
   - RabbitMQ cluster
   - Camel K platform
   ↓
6. Applications deploy (wave 2)
   - Backstage
   ↓
7. User namespaces (wave 3)
   - Created via create-user.sh script
   ↓
8. Users deploy integrations
   - kubectl apply -f integration.yaml -n user1
```

## Customization Points

### Before First Deployment

**Must Change**:
1. Update all `repoURL` fields in `argocd/applications/*.yaml`
2. Change default credentials in production
3. Configure storage class for your cluster

**Should Change**:
1. Kafka cluster size (`base/kafka/kafka-cluster.yaml`)
2. RabbitMQ replicas (`base/rabbitmq/rabbitmq-cluster.yaml`)
3. Resource limits and quotas
4. Backstage configuration

### Adding New Users

```bash
./scripts/create-user.sh username
git add overlays/users/username argocd/applications/username.yaml
git commit -m "Add user: username"
git push
```

ArgoCD automatically syncs and creates the namespace.

### Modifying Resources

All resources are managed via Git. To modify:

1. Edit files in `base/` or `overlays/`
2. Commit and push
3. ArgoCD automatically syncs changes

## Prerequisites

- Kind cluster running
- ArgoCD installed
- kubectl configured
- 8+ CPU cores, 16+ GB RAM recommended
- 50+ GB disk space for PVCs

## Quick Start

```bash
# 1. Clone and customize
git clone <your-repo>
cd gitops-platform

# 2. Update repository URLs
find argocd/applications -name "*.yaml" -exec sed -i \
  's|https://github.com/<your-org>/<your-repo>.git|YOUR_REPO|g' {} \;

# 3. Push to your Git repository
git add .
git commit -m "Initial setup"
git push

# 4. Bootstrap platform
./scripts/bootstrap-argocd.sh

# 5. Create users
./scripts/create-user.sh user1

# 6. Deploy example integrations
kubectl apply -f examples/camelk-integrations.yaml -n user-user1
```

## File Counts

- Total YAML files: 28
- ArgoCD Applications: 6
- Base configurations: 6 namespaces
- Example integrations: 6
- Scripts: 2
- Documentation files: 4

## Total Lines of Code

Approximately:
- YAML configurations: ~2,500 lines
- Documentation: ~2,000 lines
- Scripts: ~300 lines
- Total: ~4,800 lines

## License

MIT License

## Support

For issues and questions:
- Check TROUBLESHOOTING.md
- Review ARCHITECTURE.md
- Check ArgoCD UI for sync status
- Review operator logs
